<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¡Œç‰Œåˆ¶ä½œ - ç½‘é¡µç‰ˆ</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“Š</text></svg>">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: linear-gradient(135deg, #faf8f5 0%, #f0e6d2 100%);
            min-height: 100vh; padding: 20px;
        }
        .container {
            max-width: 1200px; margin: 0 auto; background: white;
            border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden; display: flex; flex-direction: column;
            min-height: calc(100vh - 40px);
        }
        .header {
            background: linear-gradient(135deg, #D2B48C 0%, #DEB887 100%);
            color: white; padding: 30px; text-align: center;
        }
        .header h1 { font-size: 32px; font-weight: 600; margin-bottom: 10px; }
        .main-content { flex: 1; padding: 40px; }
        .upload-section {
            background: #f8f9fa; border-radius: 12px; padding: 30px;
            margin-bottom: 30px; border: 2px dashed #cbd5e0;
            transition: all 0.3s;
        }
        .upload-section:hover { border-color: #D2B48C; background: #f7fafc; }
        .folder-upload {
            text-align: center; margin-bottom: 30px;
        }
        .folder-upload-button {
            display: inline-flex; align-items: center; gap: 8px;
            padding: 20px 40px; background: #D2B48C; color: white;
            border: none; border-radius: 8px; cursor: pointer;
            transition: all 0.3s; font-size: 18px; font-weight: 500;
        }
        .folder-upload-button:hover { background: #DEB887; transform: translateY(-2px); }
        .file-mapping {
            display: none; margin-top: 20px;
        }
        .file-mapping h3 { color: #2d3748; margin-bottom: 15px; }
        .file-mapping-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;
        }
        .mapping-item {
            background: #f8f9fa; padding: 15px; border-radius: 8px;
            border: 1px solid #e2e8f0; display: flex;
            justify-content: space-between; align-items: center;
        }
        .mapping-item.found { border-color: #48bb78; }
        .mapping-item.missing { border-color: #f56565; }
        .mapping-info { flex: 1; }
        .mapping-title { font-weight: 600; color: #2d3748; margin-bottom: 5px; }
        .mapping-filename { font-size: 12px; color: #666; }
        .mapping-status {
            padding: 4px 8px; border-radius: 4px; font-size: 12px;
            font-weight: 500;
        }
        .mapping-status.found { background: #48bb78; color: white; }
        .mapping-status.missing { background: #f56565; color: white; }
        .date-input-section {
            background: #f8f9fa; border-radius: 12px; padding: 30px;
            margin-bottom: 30px; border: 2px solid #e2e8f0;
        }
        .date-input-grid {
            display: grid; grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 20px; margin-bottom: 20px;
        }
        .date-input-item { display: flex; flex-direction: column; }
        .date-input-item label { font-weight: 500; color: #4a5568; margin-bottom: 8px; }
        .date-input { 
            padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;
            font-size: 14px; transition: border-color 0.3s;
            color: #D4AF37; /* é‡‘è‰² */
        }
        .date-input:focus { outline: none; border-color: #D2B48C; }
        .process-section { text-align: center; margin: 40px 0; }
        .btn {
            padding: 15px 30px; border: none; border-radius: 8px;
            font-size: 16px; font-weight: 500; cursor: pointer;
            transition: all 0.3s; display: inline-flex; align-items: center;
            gap: 10px; margin: 0 10px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .btn-primary { background: #D2B48C; color: white; }
        .btn-success { background: #48bb78; color: white; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .progress-section { margin: 30px 0; display: none; }
        .progress-bar {
            width: 100%; height: 20px; background: #e2e8f0;
            border-radius: 10px; overflow: hidden; margin-bottom: 10px;
        }
        .progress-fill {
            height: 100%; background: linear-gradient(90deg, #D2B48C, #DEB887);
            width: 0%; transition: width 0.3s;
        }
        .progress-text { text-align: center; color: #666; font-size: 14px; }
        .results-section { margin-top: 30px; display: none; }
        .results-section h3 { color: #2d3748; margin-bottom: 20px; }
        .download-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .download-item {
            background: #f8f9fa; padding: 15px; border-radius: 8px;
            border: 1px solid #e2e8f0; display: flex;
            justify-content: space-between; align-items: center;
        }
        .download-btn {
            padding: 8px 16px; background: #48bb78; color: white;
            border: none; border-radius: 6px; cursor: pointer;
            font-size: 12px; transition: background 0.3s;
        }
        .download-btn:hover { background: #38a169; }
        .log-section { margin-top: 30px; display: none; }
        .log-container {
            background: #1a202c; color: #e2e8f0; padding: 20px;
            border-radius: 8px; font-family: 'Courier New', monospace;
            font-size: 13px; line-height: 1.5; max-height: 300px; overflow-y: auto;
        }
        .log-entry { margin-bottom: 5px; }
        .log-entry.success { color: #48bb78; }
        .log-entry.error { color: #f56565; }
        .log-entry.info { color: #4299e1; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š æ¡Œç‰Œåˆ¶ä½œ</h1>
        </div>
        <div class="main-content">
            <!-- æ–‡ä»¶å¤¹ä¸Šä¼ åŒºåŸŸ -->
            <div class="upload-section">
                <h2>ğŸ“ æ–‡ä»¶å¤¹ä¸Šä¼ </h2>
                <div class="folder-upload">
                    <input type="file" id="folderInput" webkitdirectory directory multiple style="display: none;" accept=".xlsx,.xls,.jpg,.jpeg,.png">
                    <button class="folder-upload-button" onclick="document.getElementById('folderInput').click()">
                        ğŸ“‚ é€‰æ‹©æ–‡ä»¶å¤¹
                    </button>
                    <div style="margin-top: 15px; color: #666; font-size: 14px;">
                        è¯·é€‰æ‹©åŒ…å«1ä¸ªExcelè¡¨æ ¼å’Œ1å¼ å›¾ç‰‡çš„æ–‡ä»¶å¤¹
                    </div>
                </div>
                
                <div id="fileMapping" class="file-mapping">
                    <h3>ğŸ“‹ æ–‡ä»¶è¯†åˆ«ç»“æœ</h3>
                    <div class="file-mapping-grid">
                        <div class="mapping-item" id="mapping-1">
                            <div class="mapping-info">
                                <div class="mapping-title">1ï¸âƒ£ æŠ–éŸ³å¥½è¯„å›¾ç‰‡</div>
                                <div class="mapping-filename" id="file-1-name">æœªæ‰¾åˆ°</div>
                            </div>
                            <div class="mapping-status missing" id="file-1-status">ç¼ºå¤±</div>
                        </div>
                        <div class="mapping-item" id="mapping-2">
                            <div class="mapping-info">
                                <div class="mapping-title">2ï¸âƒ£ æŠ–éŸ³å¥½è¯„Excel</div>
                                <div class="mapping-filename" id="file-2-name">æœªæ‰¾åˆ°</div>
                            </div>
                            <div class="mapping-status missing" id="file-2-status">ç¼ºå¤±</div>
                        </div>
                        <div class="mapping-item" id="mapping-3">
                            <div class="mapping-info">
                                <div class="mapping-title">3ï¸âƒ£ ç¾å›¢å¥½è¯„å›¾ç‰‡</div>
                                <div class="mapping-filename" id="file-3-name">æœªæ‰¾åˆ°</div>
                            </div>
                            <div class="mapping-status missing" id="file-3-status">ç¼ºå¤±</div>
                        </div>
                        <div class="mapping-item" id="mapping-4">
                            <div class="mapping-info">
                                <div class="mapping-title">4ï¸âƒ£ ç¾å›¢å¥½è¯„Excel</div>
                                <div class="mapping-filename" id="file-4-name">æœªæ‰¾åˆ°</div>
                            </div>
                            <div class="mapping-status missing" id="file-4-status">ç¼ºå¤±</div>
                        </div>
                        <div class="mapping-item" id="mapping-5">
                            <div class="mapping-info">
                                <div class="mapping-title">5ï¸âƒ£ å›¢è´­é—¨åº—åå¯¹åº”è¡¨</div>
                                <div class="mapping-filename" id="file-5-name">æœªæ‰¾åˆ°</div>
                            </div>
                            <div class="mapping-status missing" id="file-5-status">ç¼ºå¤±</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="process-section">
                <button class="btn btn-primary" onclick="processData()" id="processBtn">ğŸš€ å¼€å§‹å¤„ç†</button>
                <button class="btn btn-success" onclick="downloadAllAsZip()" id="downloadAllBtn" style="display: none;">ğŸ“¦ æ‰“åŒ…ä¸‹è½½å…¨éƒ¨</button>
            </div>

            <div class="progress-section" id="progressSection">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">å‡†å¤‡å¼€å§‹å¤„ç†...</div>
            </div>

            <div class="results-section" id="resultsSection">
                <h3>ğŸ“‹ å¤„ç†ç»“æœ</h3>
                <div class="download-list" id="downloadList"></div>
            </div>

            <div class="log-section" id="logSection">
                <h3>ğŸ“ å¤„ç†æ—¥å¿—</h3>
                <div class="log-container" id="logContainer"></div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let uploadedFiles = {};
        let processedFiles = {};

        // æ–‡ä»¶å¤¹ä¸Šä¼ ç›‘å¬å™¨
        document.getElementById('folderInput').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            log(`ğŸ“‚ é€‰æ‹©äº†æ–‡ä»¶å¤¹ï¼ŒåŒ…å« ${files.length} ä¸ªæ–‡ä»¶`, 'info');
            
            // é‡ç½®æ–‡ä»¶æ˜ å°„æ˜¾ç¤º
            resetFileMapping();
            
            // é‡ç½®ä¸Šä¼ çš„æ–‡ä»¶
            uploadedFiles = {};
            
            // å¤„ç†æ–‡ä»¶ - æ ¹æ®æ–‡ä»¶æ‰©å±•åè¯†åˆ«
            files.forEach(file => {
                const fileName = file.name.toLowerCase();
                const extension = fileName.substring(fileName.lastIndexOf('.'));
                
                // è¯†åˆ«Excelæ–‡ä»¶ï¼ˆè·³è¿‡ä¸´æ—¶æ–‡ä»¶ï¼‰
                if (extension === '.xlsx' || extension === '.xls') {
                    // è·³è¿‡ä¸´æ—¶æ–‡ä»¶ï¼ˆä»¥ .~ æˆ– ~$ å¼€å¤´ï¼‰
                    if (file.name.startsWith('.~') || file.name.startsWith('~$')) {
                        log(`â­ï¸ è·³è¿‡ä¸´æ—¶æ–‡ä»¶: ${file.name}`, 'info');
                        return;
                    }
                    
                    if (!uploadedFiles['excel']) {
                        uploadedFiles['excel'] = file;
                        // ä½¿ç”¨ç¬¬ä¸€ä¸ªæ–‡ä»¶æ˜ å°„é¡¹æ˜¾ç¤ºExcel
                        updateFileMapping(1, file.name, 'Excelè¡¨æ ¼');
                        log(`âœ… è¯†åˆ«Excelæ–‡ä»¶: ${file.name}`, 'success');
                    } else {
                        log(`âš ï¸ å‘ç°å¤šä¸ªExcelæ–‡ä»¶ï¼Œå·²ä½¿ç”¨ç¬¬ä¸€ä¸ª: ${uploadedFiles['excel'].name}`, 'warning');
                    }
                }
                // è¯†åˆ«å›¾ç‰‡æ–‡ä»¶
                else if (extension === '.jpg' || extension === '.jpeg' || extension === '.png') {
                    if (!uploadedFiles['image']) {
                        uploadedFiles['image'] = file;
                        // ä½¿ç”¨ç¬¬äºŒä¸ªæ–‡ä»¶æ˜ å°„é¡¹æ˜¾ç¤ºå›¾ç‰‡
                        updateFileMapping(2, file.name, 'å›¾ç‰‡æ–‡ä»¶');
                        log(`âœ… è¯†åˆ«å›¾ç‰‡æ–‡ä»¶: ${file.name}`, 'success');
                } else {
                        log(`âš ï¸ å‘ç°å¤šå¼ å›¾ç‰‡ï¼Œå·²ä½¿ç”¨ç¬¬ä¸€å¼ : ${uploadedFiles['image'].name}`, 'warning');
                    }
                }
            });
            
            // æ˜¾ç¤ºæ–‡ä»¶æ˜ å°„ç»“æœ
            document.getElementById('fileMapping').style.display = 'block';
            
            // éšè—ä¸éœ€è¦çš„æ–‡ä»¶æ˜ å°„é¡¹ï¼ˆ3-5ï¼‰
            for (let i = 3; i <= 5; i++) {
                document.getElementById(`mapping-${i}`).style.display = 'none';
            }
            
            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å¿…éœ€æ–‡ä»¶éƒ½å·²ä¸Šä¼ 
            if (uploadedFiles['excel'] && uploadedFiles['image']) {
                log('âœ… æ‰€æœ‰å¿…éœ€æ–‡ä»¶å·²æ‰¾åˆ°ï¼Œå¯ä»¥å¼€å§‹å¤„ç†', 'success');
            } else {
                const missing = [];
                if (!uploadedFiles['excel']) missing.push('Excelè¡¨æ ¼');
                if (!uploadedFiles['image']) missing.push('å›¾ç‰‡æ–‡ä»¶');
                log(`âš ï¸ ç¼ºå°‘æ–‡ä»¶: ${missing.join(', ')}`, 'warning');
            }
        });

        // é‡ç½®æ–‡ä»¶æ˜ å°„æ˜¾ç¤º
        function resetFileMapping() {
            for (let i = 1; i <= 5; i++) {
                document.getElementById(`file-${i}-name`).textContent = 'æœªæ‰¾åˆ°';
                document.getElementById(`file-${i}-status`).textContent = 'ç¼ºå¤±';
                document.getElementById(`file-${i}-status`).className = 'mapping-status missing';
                document.getElementById(`mapping-${i}`).className = 'mapping-item missing';
                // æ¢å¤æ˜¾ç¤ºï¼ˆå¦‚æœä¹‹å‰è¢«éšè—äº†ï¼‰
                document.getElementById(`mapping-${i}`).style.display = '';
            }
        }

        // æ›´æ–°æ–‡ä»¶æ˜ å°„æ˜¾ç¤º
        function updateFileMapping(number, fileName, title) {
            document.getElementById(`file-${number}-name`).textContent = fileName;
            document.getElementById(`file-${number}-status`).textContent = 'å·²æ‰¾åˆ°';
            document.getElementById(`file-${number}-status`).className = 'mapping-status found';
            document.getElementById(`mapping-${number}`).className = 'mapping-item found';
            // æ›´æ–°æ ‡é¢˜ï¼ˆå¦‚æœéœ€è¦ï¼‰
            if (title) {
                const titleElement = document.querySelector(`#mapping-${number} .mapping-title`);
                if (titleElement) {
                    titleElement.textContent = title;
                }
            }
        }

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const logSection = document.getElementById('logSection');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
            logSection.style.display = 'block';
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        // æ˜¾ç¤ºè¿›åº¦æ¡
        function showProgress() {
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('processBtn').disabled = true;
        }

        // éšè—è¿›åº¦æ¡
        function hideProgress() {
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('processBtn').disabled = false;
        }

        // è¯»å–Excelæ–‡ä»¶
        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        resolve(workbook);
                    } catch (error) {
                        log(`è¯»å–æ–‡ä»¶ ${file.name} æ—¶å‡ºé”™: ${error.message}`, 'error');
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // è·å–å·¥ä½œè¡¨æ•°æ®
        function getSheetData(workbook, sheetName = null) {
            const sheet = sheetName ? workbook.Sheets[sheetName] : workbook.Sheets[workbook.SheetNames[0]];
            const range = XLSX.utils.decode_range(sheet['!ref']);
            const data = [];
            for (let row = range.s.r; row <= range.e.r; row++) {
                const rowData = [];
                for (let col = range.s.c; col <= range.e.c; col++) {
                    const cellAddress = XLSX.utils.encode_cell({r: row, c: col});
                    const cell = sheet[cellAddress];
                    rowData.push(cell ? cell.v : '');
                }
                data.push(rowData);
            }
            return data;
        }

        // åˆ›å»ºå›¾ç‰‡ç”»å¸ƒ
        function createImageCanvas(imageFile) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    resolve({ canvas, ctx, width: img.width, height: img.height });
                };
                img.onerror = reject;
                img.src = URL.createObjectURL(imageFile);
            });
        }

        // ç»˜åˆ¶æ–‡å­—åˆ°ç”»å¸ƒ
        function drawText(ctx, text, x, y, fontSize = 40, color = '#8B4513', fontFamily = 'Arial', textAlign = 'left', fontWeight = 'normal') {
            ctx.font = `${fontWeight} ${fontSize}px ${fontFamily}`;
            ctx.fillStyle = color;
            ctx.textAlign = textAlign;
            ctx.textBaseline = 'top';
            ctx.fillText(text, x, y);
        }

        // ç»˜åˆ¶é•œåƒæ–‡å­—ï¼ˆYè½´ç¿»è½¬ï¼‰- ä»¥å›¾ç‰‡ä¸­å¿ƒä¸ºè½´ç¿»è½¬
        function drawMirroredText(ctx, text, x, y, fontSize = 40, color = '#FFFFFF', fontFamily = 'Arial', textAlign = 'center', fontWeight = 'normal', imageHeight = 3000) {
            ctx.save(); // ä¿å­˜å½“å‰çŠ¶æ€
            ctx.font = `${fontWeight} ${fontSize}px ${fontFamily}`;
            ctx.fillStyle = color;
            ctx.textAlign = textAlign;
            ctx.textBaseline = 'top';
            
            // ä»¥å›¾ç‰‡ä¸­å¿ƒä¸ºè½´è¿›è¡ŒYè½´ç¿»è½¬
            const centerY = imageHeight / 2;
            ctx.translate(0, centerY);
            ctx.scale(1, -1);
            ctx.translate(0, -centerY);
            
            // ç»˜åˆ¶æ–‡å­—ï¼ˆä½¿ç”¨åŸå§‹Yåæ ‡ï¼Œä½†ä¼šè¢«ç¿»è½¬ï¼‰
            ctx.fillText(text, x, y);
            ctx.restore(); // æ¢å¤çŠ¶æ€
        }

        // ç»˜åˆ¶æ¸å˜æ–‡å­—åˆ°ç”»å¸ƒï¼ˆä»å³å¾€å·¦æ¸å˜ï¼šå³è¾¹#ffebcbï¼Œå·¦è¾¹#ffc986ï¼‰
        function drawGradientText(ctx, text, x, y, fontSize = 40, fontFamily = 'Arial', textAlign = 'center', fontWeight = 'normal', leftColor = '#ffc986', rightColor = '#ffebcb', shadowOffsetX = 0, shadowOffsetY = 0, shadowBlur = 0, shadowColor = 'rgba(0, 0, 0, 0.5)') {
            if (!text) return;
            
            ctx.save();
            ctx.font = `${fontWeight} ${fontSize}px ${fontFamily}`;
            ctx.textAlign = textAlign;
            ctx.textBaseline = 'top';
            
            // è®¾ç½®æŠ•å½±
            ctx.shadowOffsetX = shadowOffsetX;  // æ°´å¹³åç§»ï¼ˆè´Ÿå€¼å‘å·¦ï¼‰
            ctx.shadowOffsetY = shadowOffsetY;  // å‚ç›´åç§»ï¼ˆæ­£å€¼å‘ä¸‹ï¼‰
            ctx.shadowBlur = shadowBlur;        // æ¨¡ç³Šç¨‹åº¦
            ctx.shadowColor = shadowColor;      // æŠ•å½±é¢œè‰²
            
            // æµ‹é‡æ–‡å­—å®½åº¦
            const textWidth = ctx.measureText(text).width;
            
            // æ ¹æ®å¯¹é½æ–¹å¼è®¡ç®—æ¸å˜èµ·å§‹ä½ç½®
            let gradientStartX, gradientEndX;
            if (textAlign === 'center') {
                gradientStartX = x - textWidth / 2;
                gradientEndX = x + textWidth / 2;
            } else if (textAlign === 'right') {
                gradientStartX = x - textWidth;
                gradientEndX = x;
            } else { // left
                gradientStartX = x;
                gradientEndX = x + textWidth;
            }
            
            // åˆ›å»ºæ¸å˜ï¼ˆä»å·¦åˆ°å³ï¼šå·¦è¾¹#ffc986ï¼Œå³è¾¹#ffebcbï¼‰
            const gradient = ctx.createLinearGradient(gradientStartX, y, gradientEndX, y);
            gradient.addColorStop(0, leftColor);   // å·¦è¾¹ï¼ˆèµ·å§‹ï¼‰
            gradient.addColorStop(1, rightColor);  // å³è¾¹ï¼ˆç»“æŸï¼‰
            
            ctx.fillStyle = gradient;
            ctx.fillText(text, x, y);
            ctx.restore();
        }

        // ç»˜åˆ¶é•œåƒæ¸å˜æ–‡å­—ï¼ˆYè½´ç¿»è½¬ï¼‰- ä»¥å›¾ç‰‡ä¸­å¿ƒä¸ºè½´ç¿»è½¬
        function drawMirroredGradientText(ctx, text, x, y, fontSize = 40, fontFamily = 'Arial', textAlign = 'center', fontWeight = 'normal', imageHeight = 3000, leftColor = '#ffc986', rightColor = '#ffebcb', shadowOffsetX = 0, shadowOffsetY = 0, shadowBlur = 0, shadowColor = 'rgba(0, 0, 0, 0.5)') {
            if (!text) return;
            
            ctx.save(); // ä¿å­˜å½“å‰çŠ¶æ€
            ctx.font = `${fontWeight} ${fontSize}px ${fontFamily}`;
            ctx.textAlign = textAlign;
            ctx.textBaseline = 'top';
            
            // è®¾ç½®æŠ•å½±
            ctx.shadowOffsetX = shadowOffsetX;  // æ°´å¹³åç§»ï¼ˆè´Ÿå€¼å‘å·¦ï¼‰
            ctx.shadowOffsetY = shadowOffsetY;  // å‚ç›´åç§»ï¼ˆæ­£å€¼å‘ä¸‹ï¼‰
            ctx.shadowBlur = shadowBlur;        // æ¨¡ç³Šç¨‹åº¦
            ctx.shadowColor = shadowColor;      // æŠ•å½±é¢œè‰²
            
            // æµ‹é‡æ–‡å­—å®½åº¦
            const textWidth = ctx.measureText(text).width;
            
            // æ ¹æ®å¯¹é½æ–¹å¼è®¡ç®—æ¸å˜èµ·å§‹ä½ç½®
            let gradientStartX, gradientEndX;
            if (textAlign === 'center') {
                gradientStartX = x - textWidth / 2;
                gradientEndX = x + textWidth / 2;
            } else if (textAlign === 'right') {
                gradientStartX = x - textWidth;
                gradientEndX = x;
            } else { // left
                gradientStartX = x;
                gradientEndX = x + textWidth;
            }
            
            // åˆ›å»ºæ¸å˜ï¼ˆä»å·¦åˆ°å³ï¼šå·¦è¾¹#ffc986ï¼Œå³è¾¹#ffebcbï¼‰
            const gradient = ctx.createLinearGradient(gradientStartX, y, gradientEndX, y);
            gradient.addColorStop(0, leftColor);   // å·¦è¾¹ï¼ˆèµ·å§‹ï¼‰
            gradient.addColorStop(1, rightColor);  // å³è¾¹ï¼ˆç»“æŸï¼‰
            
            ctx.fillStyle = gradient;
            
            // ä»¥å›¾ç‰‡ä¸­å¿ƒä¸ºè½´è¿›è¡ŒYè½´ç¿»è½¬
            const centerY = imageHeight / 2;
            ctx.translate(0, centerY);
            ctx.scale(1, -1);
            ctx.translate(0, -centerY);
            
            // ç»˜åˆ¶æ–‡å­—ï¼ˆä½¿ç”¨åŸå§‹Yåæ ‡ï¼Œä½†ä¼šè¢«ç¿»è½¬ï¼‰
            ctx.fillText(text, x, y);
            ctx.restore(); // æ¢å¤çŠ¶æ€
        }

        // å¤„ç†å•è¡Œæ•°æ®ï¼Œç”Ÿæˆä¸€å¼ å›¾ç‰‡
        async function processSingleRow(rowData, rowIndex, imageWidth, imageHeight) {
            // rowData æ˜¯ [å§“å, å²—ä½/èŒä½åç§°, è‹±æ–‡èŒä½åç§°]
            const [name, position, engPosition] = rowData;
            
            // å¤„ç†å›¾ç‰‡
            const { canvas, ctx, width, height } = await createImageCanvas(uploadedFiles['image']);
            
            // ========== åæ ‡é…ç½®åŒºåŸŸ - æ ¹æ®å®é™…æ•ˆæœè°ƒæ•´è¿™äº›å€¼ ==========
            // å§“åä½ç½®ï¼ˆå¯ä»¥æ ¹æ®å›¾ç‰‡æ¨¡æ¿è°ƒæ•´ï¼‰
            const nameX = 1150;                 // æ°´å¹³åæ ‡ï¼ˆåƒç´ ï¼‰
            const nameY = 2040;                 // å‚ç›´åæ ‡ï¼ˆåƒç´ ï¼‰
            const nameFontSize = 330;           // å­—ä½“å¤§å°
            const nameColor = '#ffc57f';       // æ–‡å­—é¢œè‰²
            
            // å²—ä½/èŒä½åç§°ä½ç½®
            const positionX = 1150;            // æ°´å¹³åæ ‡ï¼ˆåƒç´ ï¼‰
            const positionY = 1796;             // å‚ç›´åæ ‡ï¼ˆåƒç´ ï¼‰
            const positionFontSize = 90;       // å­—ä½“å¤§å°
            const positionColor = '#ffc57f';   // æ–‡å­—é¢œè‰²
            
            // è‹±æ–‡èŒä½åç§°ä½ç½®
            const engPositionX = 1150;         // æ°´å¹³åæ ‡ï¼ˆåƒç´ ï¼‰
            const engPositionY = 1910;           // å‚ç›´åæ ‡ï¼ˆåƒç´ ï¼‰
            const engPositionFontSize = 40;    // å­—ä½“å¤§å°
            const engPositionColor = '#ffc57f'; // æ–‡å­—é¢œè‰²
            
            // æ–‡å­—å¯¹é½æ–¹å¼ï¼š'left'ï¼ˆå·¦å¯¹é½ï¼‰ã€'center'ï¼ˆå±…ä¸­ï¼‰ã€'right'ï¼ˆå³å¯¹é½ï¼‰
            const textAlign = 'center';
            // æ¸å˜è‰²é…ç½®ï¼ˆä»å³å¾€å·¦ï¼šå³è¾¹#ffebcbï¼Œå·¦è¾¹#ffc986ï¼‰
            const gradientLeftColor = '#ffc986';   // å·¦è¾¹é¢œè‰²
            const gradientRightColor = '#ffebcb';  // å³è¾¹é¢œè‰²
            
            // æŠ•å½±é…ç½®ï¼ˆå·¦ä¸‹æ–¹æŠ•å½±ï¼‰
            const shadowOffsetX = -40;        // æ°´å¹³åç§»ï¼ˆè´Ÿå€¼å‘å·¦ï¼Œå•ä½ï¼šåƒç´ ï¼‰
            const shadowOffsetY = 40;        // å‚ç›´åç§»ï¼ˆæ­£å€¼å‘ä¸‹ï¼Œå•ä½ï¼šåƒç´ ï¼‰
            const shadowBlur = 50;             // æ¨¡ç³Šç¨‹åº¦ï¼ˆæ•°å€¼è¶Šå¤§è¶Šæ¨¡ç³Šï¼Œå•ä½ï¼šåƒç´ ï¼‰
            const shadowColor = 'rgba(0, 0, 0, 0.5)'; // æŠ•å½±é¢œè‰²ï¼ˆé»‘è‰²åŠé€æ˜ï¼‰
            // ============================================================
            
            // ç»˜åˆ¶å§“åï¼ˆæ­£å¸¸ + é•œåƒï¼Œä½¿ç”¨æ¸å˜ï¼‰
            drawGradientText(ctx, name || '', nameX, nameY, nameFontSize, 'Arial', textAlign, 'normal', gradientLeftColor, gradientRightColor, shadowOffsetX, shadowOffsetY, shadowBlur, shadowColor);
            drawMirroredGradientText(ctx, name || '', nameX, nameY, nameFontSize, 'Arial', textAlign, 'normal', height, gradientLeftColor, gradientRightColor, shadowOffsetX, shadowOffsetY, shadowBlur, shadowColor);
            
            // ç»˜åˆ¶å²—ä½/èŒä½åç§°ï¼ˆæ­£å¸¸ + é•œåƒï¼Œä½¿ç”¨æ¸å˜ï¼‰
            drawGradientText(ctx, position || '', positionX, positionY, positionFontSize, 'Arial', textAlign, 'normal', gradientLeftColor, gradientRightColor, shadowOffsetX, shadowOffsetY, shadowBlur, shadowColor);
            drawMirroredGradientText(ctx, position || '', positionX, positionY, positionFontSize, 'Arial', textAlign, 'normal', height, gradientLeftColor, gradientRightColor, shadowOffsetX, shadowOffsetY, shadowBlur, shadowColor);
            
            // ç»˜åˆ¶è‹±æ–‡èŒä½åç§°ï¼ˆæ­£å¸¸ + é•œåƒï¼Œä½¿ç”¨ç»†ä½“å­—ä½“å’Œç»†ä½“ç²—ç»†ï¼Œä½¿ç”¨æ¸å˜ï¼‰
            drawGradientText(ctx, engPosition || '', engPositionX, engPositionY, engPositionFontSize, 'Helvetica Neue', textAlign, '300', gradientLeftColor, gradientRightColor, shadowOffsetX, shadowOffsetY, shadowBlur, shadowColor);
            drawMirroredGradientText(ctx, engPosition || '', engPositionX, engPositionY, engPositionFontSize, 'Helvetica Neue', textAlign, '300', height, gradientLeftColor, gradientRightColor, shadowOffsetX, shadowOffsetY, shadowBlur, shadowColor);
            
            // è½¬æ¢ä¸ºBlob
            return new Promise(resolve => {
                canvas.toBlob(resolve, 'image/jpeg', 0.9);
            });
        }

        // å¤„ç†æ‰€æœ‰è¡¨æ ¼æ•°æ®
        async function processTableData() {
            log('å¤„ç†è¡¨æ ¼æ•°æ®...', 'info');
            
            // è¯»å–Excelæ•°æ®
            const workbook = await readExcelFile(uploadedFiles['excel']);
            const excelData = getSheetData(workbook);
            
            log(`Excelæ–‡ä»¶è¯»å–å®Œæˆï¼Œå…± ${excelData.length} è¡Œæ•°æ®`, 'info');
            
            // è¯»å–3åˆ—æ•°æ®ï¼šå§“åã€å²—ä½/èŒä½åç§°ã€è‹±æ–‡èŒä½åç§°
            // å‡è®¾ç¬¬ä¸€è¡Œæ˜¯è¡¨å¤´ï¼Œä»ç¬¬äºŒè¡Œå¼€å§‹è¯»å–æ•°æ®
            const tableData = [];
            let headerRow = null;
            
            // å°è¯•è¯†åˆ«è¡¨å¤´è¡Œï¼ˆç¬¬ä¸€è¡Œï¼‰
            if (excelData.length > 0) {
                headerRow = excelData[0];
                log(`è¡¨å¤´è¡Œ: ${JSON.stringify(headerRow)}`, 'info');
            }
            
            // ä»ç¬¬äºŒè¡Œå¼€å§‹è¯»å–æ•°æ®ï¼ˆç´¢å¼•ä»1å¼€å§‹ï¼‰
            for (let i = 1; i < excelData.length; i++) {
                const row = excelData[i];
                
                // æ£€æŸ¥è¡Œæ˜¯å¦ä¸ºç©º
                if (!row || row.length === 0) {
                    continue;
                }
                
                const name = row[0];           // ç¬¬1åˆ—ï¼šå§“å
                const position = row[1];      // ç¬¬2åˆ—ï¼šå²—ä½/èŒä½åç§°
                const engPosition = row[2];    // ç¬¬3åˆ—ï¼šè‹±æ–‡èŒä½åç§°
                
                // è°ƒè¯•æ—¥å¿—ï¼šæ˜¾ç¤ºå‰å‡ è¡Œçš„æ•°æ®
                if (i <= 3) {
                    log(`ç¬¬${i}è¡Œæ•°æ®: å§“å="${name}", å²—ä½="${position}", è‹±æ–‡="${engPosition}"`, 'info');
                }
                
                // åªæ·»åŠ æœ‰å§“åçš„è¡Œï¼ˆå§“åä¸ä¸ºç©ºä¸”ä¸æ˜¯è¡¨å¤´å…³é”®è¯ï¼‰
                const nameStr = String(name || '').trim();
                if (nameStr && 
                    nameStr.toLowerCase() !== 'å§“å' && 
                    nameStr.toLowerCase() !== 'name' &&
                    nameStr.toLowerCase() !== 'å²—ä½' &&
                    nameStr.toLowerCase() !== 'èŒä½') {
                    tableData.push([
                        nameStr,
                        String(position || '').trim(),
                        String(engPosition || '').trim()
                    ]);
                }
            }
            
            if (tableData.length === 0) {
                log('âš ï¸ æœªè¯»å–åˆ°æœ‰æ•ˆæ•°æ®ï¼Œè¯·æ£€æŸ¥Excelæ–‡ä»¶æ ¼å¼', 'warning');
                log(`æç¤ºï¼šè¯·ç¡®ä¿Excelæ–‡ä»¶åŒ…å«3åˆ—ï¼ˆå§“åã€å²—ä½/èŒä½åç§°ã€è‹±æ–‡èŒä½åç§°ï¼‰ï¼Œä¸”ç¬¬ä¸€è¡Œæ˜¯è¡¨å¤´`, 'info');
                throw new Error('æœªè¯»å–åˆ°æœ‰æ•ˆæ•°æ®');
            }
            
            log(`è¯»å–åˆ° ${tableData.length} è¡Œæ•°æ®ï¼Œå¼€å§‹ç”Ÿæˆå›¾ç‰‡...`, 'success');
            
            // è·å–å›¾ç‰‡å°ºå¯¸ï¼ˆç”¨äºè®¡ç®—åæ ‡ï¼‰
            const { width, height } = await createImageCanvas(uploadedFiles['image']);
            
            // éå†æ¯ä¸€è¡Œï¼Œä¸ºæ¯ä¸€è¡Œç”Ÿæˆä¸€å¼ å›¾ç‰‡
            for (let i = 0; i < tableData.length; i++) {
                const rowData = tableData[i];
                const rowIndex = i + 1; // è¡Œå·ï¼ˆä»1å¼€å§‹ï¼‰
                
                log(`æ­£åœ¨ç”Ÿæˆç¬¬ ${rowIndex} è¡Œå›¾ç‰‡: ${rowData[0]}...`, 'info');
                
                // ä¸ºè¿™ä¸€è¡Œç”Ÿæˆå›¾ç‰‡
                const imageBlob = await processSingleRow(rowData, rowIndex, width, height);
                
                // ç”Ÿæˆæ–‡ä»¶åï¼ˆä½¿ç”¨å§“åä½œä¸ºæ–‡ä»¶åï¼Œå¦‚æœæ²¡æœ‰å§“ååˆ™ä½¿ç”¨è¡Œå·ï¼‰
                const fileName = rowData[0] 
                    ? `${rowData[0]}_æ¡Œç‰Œ.jpg` 
                    : `æ¡Œç‰Œ_ç¬¬${rowIndex}è¡Œ.jpg`;
                
                // æ·»åŠ åˆ°ä¸‹è½½åˆ—è¡¨
                addDownloadItem(fileName, imageBlob);
                
                // æ›´æ–°è¿›åº¦
                const progress = Math.floor(((i + 1) / tableData.length) * 100);
                updateProgress(progress, `å·²ç”Ÿæˆ ${i + 1}/${tableData.length} å¼ å›¾ç‰‡`);
            }
            
            log(`âœ… æ‰€æœ‰å›¾ç‰‡å·²ç”Ÿæˆå®Œæˆï¼å…± ${tableData.length} å¼ `, 'success');
        }

        // ç»˜åˆ¶è¡¨æ ¼
        function drawTable(ctx, storeCounts, startX, startY, fontSize = 40) {
            const sortedStores = Object.entries(storeCounts)
                .sort(([,a], [,b]) => b - a);
            
            const rankWidth = 100;
            const storeWidth = 200;
            const countWidth = 210;
            const rowHeight = 91;
            
            let y = startY;
            
            // ç»˜åˆ¶è¡¨å¤´
            const rankTextWidth = ctx.measureText('æ’å').width;
            const countTextWidth = ctx.measureText('å¢é•¿æ•°é‡').width;
            drawText(ctx, 'æ’å', startX + (rankWidth - rankTextWidth) / 2, y, fontSize, '#8B4513');
            drawText(ctx, 'é—¨åº—', 550, y, fontSize, '#8B4513');
            drawText(ctx, 'å¢é•¿æ•°é‡', 870 + (countWidth - countTextWidth) / 2, y, fontSize, '#8B4513');
            y += rowHeight;
            
            // ç»˜åˆ¶å‰7ä¸ªé—¨åº—
            for (let i = 0; i < Math.min(7, sortedStores.length); i++) {
                const [store, count] = sortedStores[i];
                const rank = (i >= 3) ? String(i + 1) : '';
                const countText = `${count}ä¸ª`;
                
                const rankNumWidth = ctx.measureText(rank).width;
                const countNumWidth = ctx.measureText(countText).width;
                drawText(ctx, rank, startX + (rankWidth - rankNumWidth) / 2, y, fontSize, '#8B4513');
                drawText(ctx, store, 550, y, fontSize, '#8B4513');
                drawText(ctx, countText, 870 + (countWidth - countNumWidth) / 2, y, fontSize, '#8B4513');
                y += rowHeight;
            }
            
            // ç»˜åˆ¶å7ä¸ªé—¨åº—
            y += 210;
            const rankTextWidth2 = ctx.measureText('æ’å').width;
            const countTextWidth2 = ctx.measureText('å¢é•¿æ•°é‡').width;
            drawText(ctx, 'æ’å', startX + (rankWidth - rankTextWidth2) / 2, y, fontSize, '#000000');
            drawText(ctx, 'é—¨åº—', 550, y, fontSize, '#000000');
            drawText(ctx, 'å¢é•¿æ•°é‡', 870 + (countWidth - countTextWidth2) / 2, y, fontSize, '#000000');
            y += rowHeight;
            
            const startIndex = Math.max(0, sortedStores.length - 7);
            for (let i = startIndex; i < sortedStores.length; i++) {
                const [store, count] = sortedStores[i];
                const rank = String(i + 1);
                const countText = `${count}ä¸ª`;
                
                const rankNumWidth2 = ctx.measureText(rank).width;
                const countNumWidth2 = ctx.measureText(countText).width;
                drawText(ctx, rank, startX + (rankWidth - rankNumWidth2) / 2, y, fontSize, '#000000');
                drawText(ctx, store, 550, y, fontSize, '#000000');
                drawText(ctx, countText, 870 + (countWidth - countNumWidth2) / 2, y, fontSize, '#000000');
                y += rowHeight;
            }
        }


        // æ·»åŠ ä¸‹è½½é¡¹åˆ°ç»“æœåˆ—è¡¨
        function addDownloadItem(filename, blob) {
            const downloadList = document.getElementById('downloadList');
            const item = document.createElement('div');
            item.className = 'download-item';
            
            const size = (blob.size / 1024).toFixed(1) + ' KB';
            
            item.innerHTML = `
                <div class="file-info">
                    <div class="file-name">${filename}</div>
                    <div class="file-size">å¤§å°: ${size}</div>
                </div>
                <button class="download-btn" onclick="downloadFile('${filename}')">ä¸‹è½½</button>
            `;
            
            downloadList.appendChild(item);
            processedFiles[filename] = blob;
        }

        // ä¸‹è½½å•ä¸ªæ–‡ä»¶
        function downloadFile(filename) {
            const blob = processedFiles[filename];
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ä¸»è¦å¤„ç†å‡½æ•°
        async function processData() {
            // æ£€æŸ¥å¿…éœ€æ–‡ä»¶
            if (!uploadedFiles['excel'] || !uploadedFiles['image']) {
                const missing = [];
                if (!uploadedFiles['excel']) missing.push('Excelè¡¨æ ¼');
                if (!uploadedFiles['image']) missing.push('å›¾ç‰‡æ–‡ä»¶');
                alert(`è¯·å…ˆä¸Šä¼ æ‰€æœ‰å¿…éœ€çš„æ–‡ä»¶ï¼\nç¼ºå°‘çš„æ–‡ä»¶ï¼š${missing.join(', ')}`);
                return;
            }
            
            showProgress();
            log('ğŸš€ å¼€å§‹å¤„ç†æ•°æ®...', 'info');
            
            try {
                await processTableData();
                
                updateProgress(100, 'å¤„ç†å®Œæˆï¼');
                log('âœ… æ‰€æœ‰å›¾ç‰‡å·²ç”Ÿæˆå®Œæˆï¼', 'success');
                
                document.getElementById('resultsSection').style.display = 'block';
                document.getElementById('downloadAllBtn').style.display = 'inline-flex';
                hideProgress();
                
            } catch (error) {
                log(`âŒ å¤„ç†è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: ${error.message}`, 'error');
                console.error('å¤„ç†é”™è¯¯:', error);
                hideProgress();
            }
        }

        // ä¸‹è½½å…¨éƒ¨æ–‡ä»¶ä¸ºZIPå‹ç¼©åŒ…
        async function downloadAllAsZip() {
            if (Object.keys(processedFiles).length === 0) {
                alert('æ²¡æœ‰å¯ä¸‹è½½çš„æ–‡ä»¶ï¼');
                return;
            }

            log('ğŸ“¦ å¼€å§‹åˆ›å»ºZIPå‹ç¼©åŒ…...', 'info');
            
            try {
                const zip = new JSZip();
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                
                for (const [filename, blob] of Object.entries(processedFiles)) {
                    zip.file(filename, blob);
                    log(`ğŸ“ æ·»åŠ æ–‡ä»¶åˆ°å‹ç¼©åŒ…: ${filename}`, 'info');
                }
                
                log('ğŸ“¦ æ­£åœ¨ç”ŸæˆZIPæ–‡ä»¶...', 'info');
                const zipBlob = await zip.generateAsync({type: 'blob'});
                
                const url = URL.createObjectURL(zipBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `æ¡Œç‰Œåˆ¶ä½œç»“æœ_${timestamp}.zip`;
                a.click();
                
                URL.revokeObjectURL(url);
                
                log('âœ… ZIPå‹ç¼©åŒ…ä¸‹è½½å®Œæˆï¼', 'success');
                log(`ğŸ“¦ æ–‡ä»¶åŒ…å« ${Object.keys(processedFiles).length} ä¸ªå›¾ç‰‡æ–‡ä»¶`, 'info');
                
            } catch (error) {
                log(`âŒ åˆ›å»ºZIPæ–‡ä»¶å¤±è´¥: ${error.message}`, 'error');
                console.error('ZIPåˆ›å»ºé”™è¯¯:', error);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸ“Š æ¡Œç‰Œåˆ¶ä½œå·²å°±ç»ª', 'success');
            log('è¯·é€‰æ‹©åŒ…å«æ‰€éœ€æ–‡ä»¶çš„æ–‡ä»¶å¤¹', 'info');
        });
    </script>
</body>
</html>